{% extends "layout/base.html" %} {% load static %} {% block content %}

<form id="uploadForm">
    <input type="file" allowdirs multiple webkitdirectory />
    <input type="hidden" name="auth_token" value="{{auth_token}}" />
    <input type="hidden" name="generation_id" value="{{generation_id}}" />
    <input type="hidden" name="upload_url" value="{{upload_url}}" />
    <input
        type="hidden"
        name="launch_generation_url"
        value="{{launch_generation_url}}"
    />
    <!--- FIXME: CSRF ? -->
    <button>Upload/Generate</button>
</form>

<script>
    document
        .getElementById("uploadForm")
        .addEventListener("submit", function (e) {
            e.preventDefault();

            const UPLOAD_URL = e.target.querySelector(
                "input[name=upload_url]"
            ).value;
            const AUTH_TOKEN = e.target.querySelector(
                "input[name=auth_token]"
            ).value;

            for (const file of e.target.querySelector("input[type=file]")
                .files) {
                console.log(file);

                var data = new FormData();
                data.append("file", file);
                data.append("webkitRelativePath", file.webkitRelativePath);
                fetch(UPLOAD_URL, {
                    headers: new Headers({
                        authorization: `Basic ${AUTH_TOKEN}`,
                    }),
                    method: "POST",
                    body: data,
                });
            }
        });
</script>

{% endblock %}
