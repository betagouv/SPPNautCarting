from django.conf import settings
from django.contrib.gis.geos import GEOSGeometry
from django.core.management.base import BaseCommand

from carting.models import OuvrageSection

# To export some geometries from your database, here's some Python one liner to adapt
# and run in ./manage.py shell_plus
# {
#     o.numero: o.geometry.json
#     for o in OuvrageSection.objects.filter(
#         typology=SectionTypology.SUBCHAPTER.name
#     ).exclude(geometry=None)
# }

some_geom = {
    "OUVRAGE": {
        "z99": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
    },
    "CHAPTER": {
        "3.": '{"type": "Polygon", "coordinates": [[[-1.488055, 50.0366], [-1.488055, 48.7395], [-3.088055, 49.22], [-3.088055, 50.0366], [-1.488055, 50.0366]]] }',
        "4.": '{"type": "Polygon", "coordinates": [[[-1.488055, 48.7395], [-1.488055, 48.49999], [-3.088055, 48.49999], [-3.088055, 49.22], [-1.488055, 48.7395]]] }',
        "5.": '{"type": "Polygon", "coordinates": [[[-3.088055, 49.55239], [-3.088055, 48.49901], [-4.8347633, 48.49901], [-4.8347633, 49.55239], [-3.088055, 49.55239]]] }',
        "6.": '{"type": "Polygon", "coordinates": [[[-4.2181, 48.49901], [-4.2181, 47.66563], [-6.568105, 47.66563], [-6.568105, 48.49901], [-4.2181, 48.49901]]] }',
    },
    "SUBCHAPTER": {
        "1.2.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "1.3.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "1.5.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "1.6.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "1.7.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "1.8.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "2.1.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "2.2.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "2.3.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
        "4.1.": '{ "type": "Polygon", "coordinates": [ [ [ -1.488055, 48.7395 ], [ -1.488055, 48.49999 ], [ -3.088055, 48.49999 ], [ -3.088055, 49.22 ], [ -1.488055, 48.7395 ] ] ] }',
        "4.2.": '{ "type": "Polygon", "coordinates": [ [ [ -1.8726666, 48.721 ], [ -1.566, 48.7643333 ], [ -1.3308333, 48.634 ], [ -1.8841666, 48.5983333 ], [ -1.8726666, 48.721 ] ] ] }',
        "4.3.": '{ "type": "Polygon", "coordinates": [ [ [ -1.9563333, 48.7695 ], [ -1.9188333, 48.6385 ], [ -2.1123333, 48.6078333 ], [ -2.2386666, 48.7193333 ], [ -1.9563333, 48.7695 ] ] ] }',
        "4.4.": '{ "type": "Polygon", "coordinates": [ [ [ -2.5413333, 48.8426666 ], [ -2.4488333, 48.6288333 ], [ -2.2976666, 48.6015 ], [ -1.9246666, 48.7881666 ], [ -2.5413333, 48.8426666 ] ] ] }',
        "4.5.": '{ "type": "Polygon", "coordinates": [ [ [ -3.0056666, 48.7595 ], [ -2.7193333, 48.5131666 ], [ -2.2951666, 48.6098333 ], [ -2.244, 48.7395 ], [ -2.7778333, 48.8638333 ], [ -3.0056666, 48.7595 ] ] ] }',
        "4.6.": '{ "type": "Polygon", "coordinates": [ [ [ -3.2043333, 49.0005 ], [ -3.2063333, 48.7191666 ], [ -2.699, 48.7138333 ], [ -2.701, 48.9993333 ], [ -3.2043333, 49.0005 ] ] ] }',
    },
    "PARAGRAPH": {
        "1.1.2.": '{"type": "Polygon", "coordinates": [[[-1.16808, 50.79911], [-1.16808, 48.24897], [-6.91812, 48.24897], [-6.91812, 50.79911], [-1.16808, 50.79911]]] }',
    },
    "SUBPARAGRAPH": {
        "1.6.1.1.": '{"type": "Polygon", "coordinates": [[[-2.278269, 48.671889], [-2.278269, 48.671889], [-2.292144, 48.659788], [-2.276135, 48.638047], [-2.225795, 48.658848], [ -2.278269, 48.671889]]] }',
        "1.6.3.3.": '{"type": "Polygon", "coordinates": [[[ -2.717162, 48.525906 ], [ -2.703407, 48.531979 ], [ -2.683921, 48.537292 ], [ -2.664435, 48.538810 ], [ -2.653545, 48.533877 ], [ -2.630047, 48.529322 ], [ -2.627182, 48.524768 ], [ -2.640364, 48.522870 ], [ -2.655265, 48.524009 ], [ -2.659277, 48.529322 ], [ -2.663861, 48.532738 ], [ -2.671312, 48.535774 ], [ -2.682201, 48.532738 ], [ -2.675897, 48.511481 ], [ -2.683348, 48.500849 ], [ -2.688506, 48.495152 ], [ -2.704553, 48.507684 ], [ -2.704553, 48.513759 ], [ -2.714296, 48.517176 ], [ -2.717162, 48.525906 ]]] }',
    },
    "SUBSUBPARAGRAPH": {
        "1.6.4.4.2.": '{ "type": "Polygon", "coordinates": [[[ -4.596304, 48.297629 ], [ -4.582782, 48.302212 ], [ -4.571812, 48.278447 ], [ -4.587375, 48.275391 ], [ -4.596304, 48.297629 ]]] }',
    },
    "ALINEA": {
        "1.6.4.2.0.49": '{"type": "Polygon", "coordinates": [[[ -4.576713, 48.165491 ], [ -4.533799, 48.162685 ], [ -4.544738, 48.085733 ], [ -4.585970, 48.081236 ], [ -4.576713, 48.165491 ]]] }',
        "4.1.0.07": '{"type": "Polygon", "coordinates": [[[-1.8726666, 48.721], [-1.566, 48.7643333], [-1.3308333, 48.634], [-1.8841666, 48.5983333], [-1.8726666, 48.721]]] }',
        "4.1.0.19": '{"type": "Polygon", "coordinates": [[[-2.0741666, 48.6583333], [-2.0238333, 48.6585], [-2.0265, 48.6356666], [-2.0555, 48.6351666], [-2.0741666, 48.6583333]]] }',
        "4.1.0.25": '{"type": "Polygon", "coordinates": [[[-2.0345, 48.6428333], [-2.0251666, 48.6475], [-2.022, 48.653], [-2.007, 48.6525], [-2.0095, 48.6385], [-2.0205, 48.635], [-2.0341666, 48.6388333], [-2.0345, 48.6428333]]] }',
        "4.1.0.31": '{"type": "Polygon", "coordinates": [[[-3.0715, 48.8291666], [-2.9075, 48.9211666], [-2.2841666, 48.6926666], [-2.7051666, 48.5296666], [-3.0715, 48.8291666]]] }',
        "4.1.0.37": '{"type": "Polygon", "coordinates": [[[-2.942, 49.1426666], [-2.9455, 48.9941666], [-2.6891666, 48.9965], [-2.704, 49.146], [-2.942, 49.1426666]]] }',
        "4.1.0.43": '{"type": "Polygon", "coordinates": [[[-3.1971666, 48.9685], [-3.2023333, 48.7615], [-2.6791666, 48.4775], [-1.6785, 48.5711666], [-1.9685, 48.8626666], [-3.1971666, 48.9685]]] }',
        "4.1.1.1.0.05": '{"type": "Polygon", "coordinates": [[[-2.269, 49.0475], [-1.7331666, 49.0325], [-1.6626666, 48.8441666], [-2.3711666, 48.8705], [-2.269, 49.0475]]] }',
        "4.1.1.1.0.09": '{"type": "Polygon", "coordinates": [[[-2.8745, 49.1288333], [-2.8748333, 49.0726666], [-2.762, 49.0721666], [-2.761, 49.1281666], [-2.8745, 49.1288333]]] }',
        "4.1.1.1.0.13": '{"type": "Polygon", "coordinates": [[[-2.8745, 49.1288333], [-2.8748333, 49.0726666], [-2.762, 49.0721666], [-2.761, 49.1281666], [-2.8745, 49.1288333]]] }',
        "4.1.1.1.0.17": '{"type": "Point", "coordinates": [-2.8141666, 49.105] }',
        "4.1.1.1.0.21": '{"type": "Polygon", "coordinates": [[[-2.8833333, 49.0596666], [-2.8835, 49.0038333], [-2.7643333, 49.0038333], [-2.7653333, 49.0598333], [-2.8833333, 49.0596666]]] }',
        "4.1.1.1.0.25": '{"type": "Point", "coordinates": [-2.8066666, 49.0273333] }',
        "4.1.1.1.0.29": '{"type": "Polygon", "coordinates": [[[-2.9531666, 49.1421666], [-2.956, 48.9815], [-2.6948333, 48.9815], [-2.696, 49.1411666], [-2.9531666, 49.1421666]]] }',
        # "4.1.1.1.0.33": '{"type": "Polygon", "coordinates": [[[-3.788, 49.1078333], [-2.2133333, 49.9166666], [-1.255, 49.2286666], [-1.248, 48.5171666], [-3.295, 48.4673333], [-3.788, 49.1078333]]] }',
        "4.1.1.1.0.37": '{"type": "Point", "coordinates": [-1.8936666, 48.7505] }',
        "4.1.1.1.0.41": '{"type": "Point", "coordinates": [-1.9005, 48.7301666] }',
        "4.1.1.1.0.45": '{"type": "Point", "coordinates": [-1.9403333, 48.7281666] }',
        "4.1.1.1.0.49": '{"type": "Point", "coordinates": [-2.0873333, 48.8078333] }',
        "4.1.1.1.0.53": '{"type": "Point", "coordinates": [-2.202, 48.7548333] }',
        "4.1.1.1.0.57": '{"type": "Point", "coordinates": [-2.2478333, 48.7081666] }',
        "4.1.1.1.0.65": '{"type": "Polygon", "coordinates": [[[-2.1963333, 48.6768333], [-2.1965, 48.6693333], [-2.1778333, 48.6695], [-2.1783333, 48.6768333], [-2.1963333, 48.6768333]]] }',
        "4.1.1.1.0.73": '{"type": "Polygon", "coordinates": [[[-3.0436666, 48.9206666], [-3.0443333, 48.8223333], [-2.8488333, 48.8223333], [-2.8498333, 48.9231666], [-3.0436666, 48.9206666]]] }',
        "4.1.1.1.0.77": '{"type": "Polygon", "coordinates": [[[-2.9328333, 48.9135], [-2.9335, 48.885], [-2.8758333, 48.885], [-2.8766666, 48.9133333], [-2.9328333, 48.9135]]] }',
        "4.1.1.1.0.81": '{"type": "Polygon", "coordinates": [[[-2.9611666, 48.8923333], [-2.9616666, 48.8508333], [-2.905, 48.8503333], [-2.905, 48.8921666], [-2.9611666, 48.8923333]]] }',
        "4.1.1.1.0.85": '{"type": "Polygon", "coordinates": [[[-2.9451666, 48.8418333], [-2.867, 48.8418333], [-2.8675, 48.8836666], [-2.9438333, 48.8835], [-2.9451666, 48.8418333]]] }',
        "4.1.1.1.0.89": '{"type": "Polygon", "coordinates": [[[-2.9071666, 48.828], [-2.912, 48.816], [-2.8886666, 48.8146666], [-2.8913333, 48.8275], [-2.9071666, 48.828]]] }',
        "4.1.1.1.0.93": '{"type": "Polygon", "coordinates": [[[-2.908, 48.7765], [-2.9085, 48.7646666], [-2.877, 48.7645], [-2.8778333, 48.7763333], [-2.908, 48.7765]]] }',
        "4.1.1.2.1.0.07": '{"type": "Polygon", "coordinates": [[[-1.5193333, 48.7885], [-1.459, 48.5943333], [-2.4256666, 48.5975], [-2.428, 48.8583333], [-1.5193333, 48.7885]]] }',
        "4.1.1.2.1.0.13": '{"type": "Polygon", "coordinates": [[[-1.917, 48.6916666], [-1.5723333, 48.8545], [-1.294, 48.6535], [-1.8568333, 48.557], [-1.917, 48.6916666]]] }',
        "4.1.1.2.1.0.19": '{"type": "Polygon", "coordinates": [[[-1.9066666, 48.7188333], [-1.9066666, 48.6955], [-1.9638333, 48.6958333], [-1.9626666, 48.7185], [-1.9066666, 48.7188333]]] }',
        "4.1.1.2.1.0.25": '{"type": "Polygon", "coordinates": [[[-1.9563333, 48.7695], [-1.9188333, 48.6385], [-2.1123333, 48.6078333], [-2.2386666, 48.7193333], [-1.9563333, 48.7695]]] }',
        "4.1.1.2.1.0.31": '{"type": "Polygon", "coordinates": [[[-1.9563333, 48.7695], [-1.9188333, 48.6385], [-2.1123333, 48.6078333], [-2.2386666, 48.7193333], [-1.9563333, 48.7695]]] }',
        "4.1.1.2.1.0.43": '{"type": "Point", "coordinates": [-2.0466666, 48.6516666] }',
        "4.1.1.2.1.0.49": '{"type": "Polygon", "coordinates": [[[-1.9563333, 48.7695], [-1.9188333, 48.6385], [-2.1123333, 48.6078333], [-2.2386666, 48.7193333], [-1.9563333, 48.7695]]] }',
        "4.1.1.2.2.0.07": '{"type": "Polygon", "coordinates": [[[-3.0056666, 48.7595], [-2.7193333, 48.5131666], [-2.2951666, 48.6098333], [-2.244, 48.7395], [-2.7778333, 48.8638333], [-3.0056666, 48.7595]]] }',
        "4.1.1.2.2.0.13": '{"type": "Polygon", "coordinates": [[[-2.5413333, 48.8426666], [-2.4488333, 48.6288333], [-2.2976666, 48.6015], [-1.9246666, 48.7881666], [-2.5413333, 48.8426666]]] }',
        "4.1.1.2.2.0.19": '{"type": "Polygon", "coordinates": [[[-2.3946666, 48.7048333], [-2.3938333, 48.6745], [-2.3165, 48.6746666], [-2.3126666, 48.704], [-2.3946666, 48.7048333]]] }',
        "4.1.1.2.2.0.25": '{"type": "Polygon", "coordinates": [[[-2.3206666, 48.6941666], [-2.3171666, 48.6783333], [-2.4086666, 48.6375], [-2.4891666, 48.6536666], [-2.445, 48.6935], [-2.3206666, 48.6941666]]] }',
        "4.1.1.2.2.0.31": '{"type": "Polygon", "coordinates": [[[-2.8398333, 48.6016666], [-2.7895, 48.616], [-2.6988333, 48.5836666], [-2.5936666, 48.5966666], [-2.54, 48.5725], [-2.6325, 48.5223333], [-2.7348333, 48.5293333], [-2.8398333, 48.6016666]]] }',
        "4.1.1.2.2.0.37": '{"type": "Polygon", "coordinates": [[[-2.9243333, 48.7145], [-2.3458333, 48.6973333], [-2.5928333, 48.5126666], [-2.795, 48.512], [-2.9243333, 48.7145]]] }',
        "4.1.1.2.2.0.43": '{"type": "Point", "coordinates": [-2.6218333, 48.6693333] }',
        "4.1.1.2.3.0.13": '{"type": "Polygon", "coordinates": [[[-3.2043333, 49.0005], [-3.2063333, 48.7191666], [-2.699, 48.7138333], [-2.701, 48.9993333], [-3.2043333, 49.0005]]] }',
        "4.1.1.2.3.0.19": '{"type": "Polygon", "coordinates": [[[-3.2043333, 49.0005], [-3.2063333, 48.7191666], [-2.699, 48.7138333], [-2.701, 48.9993333], [-3.2043333, 49.0005]]] }',
        "4.1.1.2.3.0.25": '{"type": "Polygon", "coordinates": [[[-2.9448333, 48.9151666], [-2.9458333, 48.8735], [-2.8665, 48.8733333], [-2.8676666, 48.9155], [-2.9448333, 48.9151666]]] }',
        "4.1.1.2.3.0.31": '{"type": "Polygon", "coordinates": [[[-3.1181666, 48.9248333], [-3.1188333, 48.8958333], [-3.0596666, 48.8961666], [-3.059, 48.9251666], [-3.1181666, 48.9248333]]] }',
        "4.1.5.3.0.19": '{"type": "Polygon", "coordinates": [[[-2.8025, 48.6603333], [-2.7953333, 48.6648333], [-2.783, 48.6666666], [-2.7725, 48.6638333], [-2.7651666, 48.657], [-2.7663333, 48.647], [-2.7786666, 48.6403333], [-2.8005, 48.6416666], [-2.8043333, 48.6516666], [-2.8025, 48.6603333]]] }',
        "4.6.1.2.0.19": '{"type": "LineString", "coordinates": [[-2.977, 48.9098333], [-2.9528333, 48.8383333], [-2.9656666, 48.8025]] }',
    },
    "TOPONYME": {
        "4.1.1.1.0.09": '{"type": "Point", "coordinates": [-2.81417, 49.105] }',
        "4.1.1.1.0.37": '{"type": "Point", "coordinates": [-1.89367, 48.7505] }',  # iso alinea
        "4.1.1.1.0.41": '{"type": "Point", "coordinates": [-1.9005, 48.73017] }',  # iso alinea
        "4.1.1.1.0.45": '{"type": "Point", "coordinates": [-1.94033, 48.7282] }',  # iso alinea
        "4.1.1.1.0.57": '{"type": "Point", "coordinates": [-2.24783, 48.7082] }',  # iso alinea
        "4.1.2.2.0.25": '{"type": "Point", "coordinates": [-2.9205, 48.89167] }',
        "4.5.1.1.0.37": '{"type": "Point", "coordinates": [-2.64183, 48.5565] }',
        "4.5.1.3.0.25": '{"type": "Point", "coordinates": [-2.749, 48.62283] }',
        "4.5.2.0.49": '{"type": "Point", "coordinates": [-2.48833, 48.64533] }',
        "4.5.2.0.65": '{"type": "Point", "coordinates": [-2.55467, 48.59617] }',
        "4.5.3.1.0.07": '{"type": "Point", "coordinates": [-2.47583, 48.63417] }',
        "4.5.3.2.0.19": '{"type": "Point", "coordinates": [-2.52433, 48.64183] }',
        "4.5.6.0.05": '{"type": "Point", "coordinates": [-2.7755, 48.60817] }',
        "4.5.6.0.13": '{"type": "Point", "coordinates": [-2.7795, 48.585] }',
        "4.5.6.0.41": '{"type": "Point", "coordinates": [-2.86667, 48.6715] }',
        "4.5.6.0.57": '{"type": "Point", "coordinates": [-2.8983, 48.70117] }',
    },
    "ILLUSTRATION": {
        "1.6.3.2.": '{"type": "Polygon", "coordinates": [[[-4.775538, 48.491740], [-5.460019, 48.496984], [-5.467932, 48.344690], [-5.301757, 47.993739], [-4.751799, 48.022856], [-4.743886, 48.081041], [-4.292841, 48.123316], [-4.312623, 48.207762], [-4.474841, 48.234122], [-4.522320, 48.176111], [-4.573755, 48.231487], [-4.530233, 48.249932], [-4.617277, 48.252567], [-4.613320, 48.328909], [-4.684538, 48.349949], [-4.759712, 48.323648], [-4.795321, 48.363094], [-4.775538, 48.491740]]] }',
        "1.6.4.4.1.": '{ "type": "Polygon", "coordinates": [[[ -4.600080, 48.312418 ], [ -4.878713, 48.308921 ], [ -4.899742, 48.406734 ], [ -5.257234, 48.399754 ], [ -5.215176, 48.014356 ], [ -4.847170, 48.035453 ], [ -4.852427, 48.098690 ], [ -4.563279, 48.116243 ], [ -4.600080, 48.312418 ]]] }',
    },
}


class Command(BaseCommand):
    def handle(self, *args, **options):
        for typology, geoms in some_geom.items():
            in_sections = OuvrageSection.objects.filter(
                ouvrage_name="z99", numero__in=geoms.keys(), typology=typology
            ).order_by("numero")

            for geometry, in_section in zip(geoms.values(), in_sections, strict=True):
                in_section.geometry = GEOSGeometry(geometry)
            updated = OuvrageSection.objects.bulk_update(in_sections, ["geometry"])
            print(f"{updated} {typology} géométrisées")
